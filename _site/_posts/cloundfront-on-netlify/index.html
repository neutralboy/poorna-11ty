<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="/index.css" />
    <title>Deploying Next.js on Cloudfront | Poorna's blog</title>
    <link
      rel="icon"
      type="image/png"
      href="https://res.cloudinary.com/poorna/image/upload/v1622972701/my-blog/logo/Screenshot_2021-06-06_at_15-14-35_Home_Poorna_s_Blog.png"
    />
    <meta name="description" content="Leverage the powerful infrastructure of AWS to deploy your next Next.js site" />
    <meta property="og:description" content="Leverage the powerful infrastructure of AWS to deploy your next Next.js site" />
    <meta property="og:title" content="Deploying Next.js on Cloudfront | Poorna's Blog " />
    <meta property="og:type" content="blog" />
    <meta property="og:url" content="https://www.poorna.dev/_posts/cloundfront-on-netlify/" />
    <meta
      property="og:image"
      content="https://res.cloudinary.com/poorna/image/upload/v1640502671/my-blog/poorna%20blog%20image.png"
    />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:alt" content="Poorna's blog logo" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:article:published_time" content="Sat Feb 13 2021 19:54:59 GMT+0530 (India Standard Time)" />
    <meta property="og:article:tag" content="" />
    <meta property="og:article:author" content="Poornachandra" />
  </head>

  <body class="bg-slate-200 font-primary">
    <nav class="w-full top-0 sticky py-5 bg-indigo-900">
      <div class="lg:container mx-auto flex justify-between">
        <a
          href="/"
          class="text-3xl underline text-slate-200 font-bold block my-auto"
        >
          Poorna
        </a>
        <div class="flex gap-x-4">
          <a href="/say-hello" class="text-slate-200 text-lg block my-auto hover:underline hover:text-slate-100">
            Say Hello
          </a>
          <a
            rel="noopener"
            href="https://www.linkedin.com/in/poornachandra-v/"
            class="p-0.5 bg-blue-500 hover:bg-blue-600 lg:block hidden my-auto"
          >
            <svg
              class="fill-current text-white block"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M13 21H9V9H13V11C13.8526 9.91525 15.1456 9.26857 16.525 9.237C19.0056 9.25077 21.0072 11.2694 21 13.75V21H17V14.25C16.84 13.1326 15.8818 12.3036 14.753 12.306C14.2593 12.3216 13.7932 12.5378 13.4624 12.9046C13.1316 13.2715 12.9646 13.7573 13 14.25V21ZM7 21H3V9H7V21ZM5 7C3.89543 7 3 6.10457 3 5C3 3.89543 3.89543 3 5 3C6.10457 3 7 3.89543 7 5C7 5.53043 6.78929 6.03914 6.41421 6.41421C6.03914 6.78929 5.53043 7 5 7Z"
              ></path>
            </svg>
          </a>
        </div>
      </div>
    </nav>

    <div
      class="bg-indigo-800 py-10 mb-14 flex justify-center border-b-8 border-b-indigo-600"
    >
      <div class="lg:container mx-auto flex justify-between px-4">
        <h1 class="text-5xl font-bold text-slate-100 block my-auto">
          Deploying Next.js on Cloudfront
        </h1>
        <p
          class="block my-auto text-gray-600 bg-slate-200 px-2 py-1 rounded-md"
        >
          Hard
        </p>
      </div>
    </div>

    <div class="lg:container px-4 mx-auto">
      <div class="prose max-w-none mb-10"><h1>Why deploy Next.js on Cloudfront ?</h1>
<p>You can use services such as Netlify or Vercel to generate and deploy you static site. These services leverage AWS architecture or equivalents such as GCP or Azure to deploy your site on the CDN.</p>
<p><strong>Netlify Free tier</strong>: Netlify provides 300 free build minutes per month.</p>
<p><strong>AWS CloudBuild Free tier</strong>: AWS CodeBuild provides 100 free build minutes. So, 300 minutes will cost you 300-100(free minutes) = 200. 200 min Ã— $0.005/min = $1
Other things to factor in
1. S3: 0.025$/GB - One static site will typically be around 100MB
2. DNS: 0.5$ per domain (Avoidable if you buy your domain on GoDaddy and use their built in DNS service.)
3. CodePipeline: 0.5$ per code pipeline
4. Free tier of AWS CloudFront. (Free tier for a year, after which it adds upto less than 5$ a month.)
To deploy site per month it costs - $2.025</p>
<p>The bet on AWS pays off if you have high loads and greater than 1 concurrent builds.
Netlify allows 3 concurrent builds on the $19 plan. On AWS the same costs around $2.025 + 2 more Code pipelines at 0.5$ each. Total at 3.025$</p>
<p>The only disadvantage of using AWS is the need for intricate techinical knowledge on how to deploy your code. Netlify uses your <code>package.json</code> data commands to build and configure your site.</p>
<hr>
<h1>Moving Parts</h1>
<ol>
<li>Git</li>
<li>AWS CodePipeline - to configure triggers</li>
<li>AWS CodeBuild - to build and package our code</li>
<li>AWS S3 - to store the build artifacts</li>
<li>AWS Cloudfront - to distrubute our site</li>
</ol>
<hr>
<h2>Git</h2>
<p>Setup your code on git and commit all of it.
Use any of Github, Butbucket or Gitlab to maintain your code.</p>
<hr>
<h2>Setup CodePipeline</h2>
<blockquote>
<p>AWS CodePipeline is a tool that looks for commits and pulls made to a git repository and triggers an action on the code. Action may be postprocessing of data, building container images, exporting static files and so on.</p>
</blockquote>
<ol>
<li>
<h3>Add build command to your NextJS project</h3>
<p>Add the build command to <code>package.json</code> file of your NextJS project. This command will help us build and export the project. <code>next export</code> generates a pre-rendered HTML export into a folder named <code>out</code>.</p>
<pre><code>...
build: next build &amp;&amp; next export
...
</code></pre>
</li>
<li>
<h3>Go to the CodePipeline section and use the <code>Create pipeline</code> button.</h3>
<p><img src="https://res.cloudinary.com/poorna/image/upload/c_scale,w_900/v1612627201/my-blog/Screenshot_2021-02-06_CodePipeline_-_AWS_Developer_Tools.png" alt="Create Pipeline"></p>
</li>
<li>
<h3>Name your pipeline and use the New Service Role, it should give you enough permissions to make it work.</h3>
<p><img src="https://res.cloudinary.com/poorna/image/upload/c_scale,w_900/v1612627422/my-blog/Screenshot_2021-02-06_CodePipeline_-_AWS_Developer_Tools_2.png" alt="Name and create role">
Click on next</p>
</li>
<li>
<h3>Now choose the source of code</h3>
<p><img src="https://res.cloudinary.com/poorna/image/upload/c_scale,w_900/v1612627533/my-blog/Screenshot_2021-02-06_CodePipeline_-_AWS_Developer_Tools_3.png" alt="Source of code">
One you choose your source, AWS will ask you to connect your repo to the pipeline. Provide all necessary permissions.
Click Next.</p>
</li>
<li>
<h3>Configuring the build stage</h3>
<p>Use the Create Project button
<img src="https://res.cloudinary.com/poorna/image/upload/v1613212748/my-blog/Screenshot_2021-02-13_CodePipeline_-_AWS_Developer_Tools.png" alt="Create CodeBuild Project"></p>
</li>
<li>
<h3>Configuring AWS CodeBuild Environment</h3>
<blockquote>
<p>Image registry: Other registry
Custom Docker image registry URL: registry.hub.docker.com/library/node:alpine
Previleged: True
<img src="https://res.cloudinary.com/poorna/image/upload/v1613212593/my-blog/Screenshot_2021-02-13_CodeBuild_-_AWS_Developer_Tools.png" alt="Configure AWS Codebuild Environment"></p>
</blockquote>
</li>
<li>
<h3>Configure AWS Codebuild Command</h3>
<p>Choose the Insert custom build command option and enter the <code>npm run build</code> .
<img src="https://res.cloudinary.com/poorna/image/upload/v1613213066/my-blog/Screenshot_2021-02-13_CodeBuild_-_AWS_Developer_Tools_1.png" alt="Configure AWS Codebuild Environment"></p>
</li>
<li>
<h3>Choose AWS S3 as your deploy stage</h3>
<p><img src="https://res.cloudinary.com/poorna/image/upload/v1612627954/my-blog/Screenshot_2021-02-06_CodePipeline_-_AWS_Developer_Tools_5.png" alt="AWS S3 as deploy stage">
Choose any of your S3 buckets</p>
<blockquote>
<p>Check the Extract file before deploy option
<img src="https://res.cloudinary.com/poorna/image/upload/v1612628101/my-blog/Screenshot_2021-02-06_CodePipeline_-_AWS_Developer_Tools_6.png" alt="Extract before deploy"></p>
</blockquote>
</li>
<li>
<h3>Review and create your pipeline</h3>
<h4>Now commit a change to your code and check if its being executed.</h4>
<p>Click on the pipeline you just created and view its history. If the trigger has been setup correctly, here's what you'll see.</p>
<p><img src="https://res.cloudinary.com/poorna/image/upload/c_scale,w_900/v1612628312/my-blog/Screenshot_2021-02-06_CodePipeline_-_AWS_Developer_Tools_7.png" alt="Successful Trigger"></p>
</li>
</ol>
</div>
    </div>

    <a href="/" class="sticky bottom-0 text-xl bg-white px-3 py-2 rounded-r-md">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6 inline"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"
        />
      </svg>
      Go back
    </a>
  </body>
</html>
